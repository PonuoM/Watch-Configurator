<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîß ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Assets v2</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./supabase.config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 900px;
      width: 100%;
      padding: 40px;
    }
    h1 {
      color: #1a202c;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .status {
      background: #f7fafc;
      border-left: 4px solid #4299e1;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .status.success { border-color: #48bb78; background: #f0fff4; }
    .status.error { border-color: #f56565; background: #fff5f5; }
    .status.warning { border-color: #ed8936; background: #fffaf0; }
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn:hover { background: #5568d3; transform: translateY(-2px); }
    .btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }
    .btn-danger {
      background: #f56565;
    }
    .btn-danger:hover { background: #e53e3e; }
    #log {
      background: #1a202c;
      color: #48bb78;
      font-family: 'Monaco', 'Courier New', monospace;
      padding: 20px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.6;
      margin-top: 20px;
    }
    .log-line {
      margin-bottom: 4px;
    }
    .log-error { color: #fc8181; }
    .log-success { color: #68d391; }
    .log-info { color: #63b3ed; }
    .log-warning { color: #fbd38d; }
    .progress {
      margin: 20px 0;
    }
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      text-align: center;
      margin-top: 8px;
      font-size: 14px;
      color: #4a5568;
      font-weight: 600;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Assets (Version 2)</h1>
    <p class="subtitle">Query ‡∏à‡∏≤‡∏Å storage.objects ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á - ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤!</p>

    <div class="status warning" id="initial-status">
      <strong>‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:</strong><br>
      - ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á assets records ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Storage<br>
      - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ URL ‡∏ã‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
      - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡∏°‡πà
    </div>

    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="stat-files">0</div>
        <div class="stat-label">‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Storage</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-restored">0</div>
        <div class="stat-label">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-skipped">0</div>
        <div class="stat-label">‡∏Ç‡πâ‡∏≤‡∏°/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>
      </div>
    </div>

    <div>
      <button class="btn" onclick="startRestore()" id="btn-restore">
        üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
      <button class="btn btn-danger" onclick="clearAssets()" id="btn-clear">
        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Assets ‡∏Å‡πà‡∏≠‡∏ô
      </button>
    </div>

    <div class="progress" id="progress-container" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-text" id="progress-text">0%</div>
    </div>

    <div id="log"></div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      window.SUPABASE_URL,
      window.SUPABASE_ANON_KEY
    );

    let stats = { files: 0, restored: 0, skipped: 0 };

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const line = document.createElement('div');
      line.className = `log-line log-${type}`;
      const timestamp = new Date().toLocaleTimeString('th-TH');
      line.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateProgress(current, total) {
      const percent = Math.round((current / total) * 100);
      document.getElementById('progress-fill').style.width = percent + '%';
      document.getElementById('progress-text').textContent = `${percent}% (${current}/${total})`;
    }

    function updateStats() {
      document.getElementById('stat-files').textContent = stats.files;
      document.getElementById('stat-restored').textContent = stats.restored;
      document.getElementById('stat-skipped').textContent = stats.skipped;
      document.getElementById('stats').style.display = 'grid';
    }

    async function startRestore() {
      if (!confirm('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Storage?\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á assets records')) {
        return;
      }

      log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Storage...', 'info');
      document.getElementById('btn-restore').disabled = true;
      document.getElementById('progress-container').style.display = 'block';
      stats = { files: 0, restored: 0, skipped: 0 };

      try {
        // Query storage.objects directly
        const { data: files, error } = await supabase.rpc('get_storage_files', {});
        
        // If RPC doesn't exist, use SQL query
        if (error) {
          log('‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ SQL query ‡πÅ‡∏ó‡∏ô...', 'warning');
          const { data: sqlFiles, error: sqlError } = await supabase
            .from('storage.objects')
            .select('name, bucket_id')
            .eq('bucket_id', 'watch-assets')
            .order('created_at', { ascending: false });
          
          if (sqlError) {
            throw sqlError;
          }
          
          files = sqlFiles || [];
        }

        if (!files || files.length === 0) {
          log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Storage', 'error');
          return;
        }

        stats.files = files.length;
        updateStats();
        log(`‚úÖ ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${files.length} ‡πÑ‡∏ü‡∏•‡πå`, 'success');

        // Process each file
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          updateProgress(i + 1, files.length);

          try {
            // Parse file path: {sku}/{group_key}/{filename}
            const name = file.name || file;
            const parts = name.split('/');

            if (parts.length < 2) {
              log(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°: ${name} (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)`, 'warning');
              stats.skipped++;
              continue;
            }

            let skuId, groupKey, filename;
            
            if (parts.length === 3) {
              [skuId, groupKey, filename] = parts;
            } else if (parts.length === 2) {
              [skuId, filename] = parts;
              groupKey = 'unknown';
            } else {
              // More than 3 parts, use last 3
              groupKey = parts[parts.length - 2];
              filename = parts[parts.length - 1];
              skuId = parts.slice(0, -2).join('/');
            }

            // Skip non-image files
            if (!filename.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
              stats.skipped++;
              continue;
            }

            // Get public URL
            const { data: urlData } = supabase.storage
              .from('watch-assets')
              .getPublicUrl(name);

            if (!urlData || !urlData.publicUrl) {
              log(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°: ${name} (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á URL)`, 'warning');
              stats.skipped++;
              continue;
            }

            const url = urlData.publicUrl;

            // Check if this URL already exists
            const { data: existing } = await supabase
              .from('assets')
              .select('id')
              .eq('url', url)
              .limit(1);

            if (existing && existing.length > 0) {
              // Already exists, skip
              stats.skipped++;
              if (i % 20 === 0) {
                log(`‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°: ${name} (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)`, 'info');
              }
              continue;
            }

            // Create label from filename
            const label = filename
              .replace(/\.[^/.]+$/, '')           // Remove extension
              .replace(/^\d+-\d+-/, '')            // Remove timestamp prefix
              .replace(/[-_]+/g, ' ')              // Replace - or _ with space
              .trim();

            // Insert into assets
            const { data, error: insertError } = await supabase
              .from('assets')
              .insert({
                sku_id: skuId,
                group_key: groupKey,
                label: label || filename,
                url: url,
                sort: i + 1
              })
              .select();

            if (insertError) {
              if (insertError.message.includes('foreign key') || 
                  insertError.message.includes('violates') ||
                  insertError.code === '23503') {
                log(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°: ${name} (SKU "${skuId}" ‡∏´‡∏£‡∏∑‡∏≠ group_key "${groupKey}" ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)`, 'warning');
                stats.skipped++;
              } else {
                throw insertError;
              }
            } else {
              stats.restored++;
              if (i % 10 === 0 || stats.restored <= 5) {
                log(`‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô: ${name}`, 'success');
              }
            }

          } catch (error) {
            log(`‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${file.name || file} - ${error.message}`, 'error');
            stats.skipped++;
          }

          updateStats();
          
          // Throttle to avoid rate limits
          if (i % 10 === 0) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }

        log(`\nüéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!`, 'success');
        log(`‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${stats.restored} ‡πÑ‡∏ü‡∏•‡πå`, 'success');
        log(`‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${stats.skipped} ‡πÑ‡∏ü‡∏•‡πå`, 'info');
        
        if (stats.restored > 0) {
          log(`\nüìå ‡πÄ‡∏õ‡∏¥‡∏î check-restore-status.html ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå`, 'info');
        }

      } catch (error) {
        log(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á: ${error.message}`, 'error');
        console.error(error);
      } finally {
        document.getElementById('btn-restore').disabled = false;
      }
    }

    async function clearAssets() {
      if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ\n‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
      }

      if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2!\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô assets ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á?')) {
        return;
      }

      log('üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• assets...', 'warning');

      try {
        // Delete all assets
        const { error } = await supabase
          .from('assets')
          .delete()
          .neq('id', '00000000-0000-0000-0000-000000000000');
        
        if (error) throw error;
        
        log('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
        stats.restored = 0;
        updateStats();
      } catch (error) {
        log(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
      }
    }

    // Init
    log('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
    log('üìå ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'info');
    log('üí° ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Assets" ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà', 'info');
  </script>
</body>
</html>

